---
title: "TGI Spinal Analysis Code"
author: "A.G. Mitchell"
date: "2022-12-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Loading libraries
library(RColorBrewer)
library(ggpubr)
library(Rmisc)
library(tidyverse)
library(gghalves)
library(ggpol)
```

# Loading data
```{r paths, echo = FALSE}
# paths
datPath <- '/Users/au706616/Documents/Experiments/SPINALTGI/Raw/'
anaPath <- '/Users/au706616/Documents/Experiments/SPINALTGI/Analysis/'

# Extract all .csv files and compile
filenames <- dir(datPath, recursive = TRUE, full.names = FALSE, pattern = '.csv')
# empty dataframes for data
## with new data trials file will have changed to include temperature coding!
df_trials <- read.csv(text='procedure,trial_type,arm,condition,dermatome,order,cold_probe,trial_n,coolTemp,warmTempID,manipulation')
df_VAS <- read.csv(text='VASinit,VASburn,VASwarm,VAScold,trial_n,ID,manipulation')
df_RT <- read.csv(text='RTinit,RTburn,RTwarm,RTcold,trial_n,ID,manipulation')

## Data compiling
# trial files
setwd(datPath)
for (file in filenames){
  # trial files
  if (isTRUE(substr(basename(file), 24, 24)=="t")){
    tmp <- read.csv(file)
    tmp$ID <- substr(basename(file), 4, 6)
    tmp$manipulation <- substr(basename(file), 17, 19)
    df_trials <- rbind(df_trials, tmp)
  }
  # VAS response files
  if (isTRUE(substr(basename(file), 24, 29)=="rating")){
    tmp <- read.csv(file, header = FALSE)
    colnames(tmp) <- c('VASinit','VASburn','VASwarm','VAScold','trial_n')
    tmp$ID <- substr(basename(file), 4, 6)
    tmp$manipulation <- substr(basename(file), 17, 19)
    df_VAS <- rbind(df_VAS, tmp)
  }
  # VAS RT files
  if (isTRUE(substr(basename(file), 24, 29)=="respti")){
    tmp <- read.csv(file, header = FALSE)
    colnames(tmp) <- c('RTinit','RTburn','RTwarm','RTcold','trial_n')
    tmp$ID <- substr(basename(file), 4, 6)
    tmp$manipulation <- substr(basename(file), 17, 19)
    df_RT <- rbind(df_RT, tmp)
  }
}

# merge all files
df_res <- merge(df_trials, df_VAS, by = c('ID','trial_n','manipulation'))
df_res <- merge(df_res, df_RT, by = c('ID','trial_n','manipulation'))

# remove participant 019, stopped testing halfway
df_res <- df_res[df_res$ID != '019' ,]
```

# Data organisation
```{r}
# transform the ID of participants to remove 0
df_res$ID <- as.numeric(df_res$ID)
# recode conditions
df_res <- df_res %>%
  mutate(condition = recode(condition, '1' = 'within', '2' = 'across'),
         cold_probe = recode(cold_probe, 'C6' = 'rostral', 'T1' = 'caudal',
                             'dist' = 'distal', 'prox' = 'proximal'))
# change levels 
df_res$cold_probe <- factor(df_res$cold_probe, 
                            levels = c("caudal", "rostral", "distal", "proximal"))

# incorporate demographics
# the warm and cold TGI and CNT temperatures did not code properly on the trial .csv
# have saved these in the demo .csv as well, so will add these in
demoFile <- 'STGI_participant-demographics.csv'
fileName = paste(datPath, demoFile, sep = '')
df_demo <- read.csv(fileName)
# merge
test <- merge(df_res, df_demo)

# save new data-frame
fileName = paste(anaPath, 'STGI_compiled-data.csv', sep = '')
write.csv(df_res, fileName, row.names = FALSE)

# check we have 40 participants with 96 trials
id_check <- count(df_res, ID)
id_check
```


# Responder check
Check whether participants median burning ratings for TGI is significantly above 0
If not, flag them as a 'non-responder'
```{r}
# Calculate median burning rating for all participants
# TGI trials only
# Then flag how many are not sig > 0
df_med <- aggregate(VASburn~ID*manipulation*cold_probe*trial_type, median, data = df_res)
tgi <-  df_med %>% 
  filter(manipulation == 'TGI')
cnt <-  df_med %>% 
  filter(manipulation == 'CNT')

# identify test results where pvalue is < .05
tgi$ID <- as.factor(tgi$ID)
i = 0
test = data.frame(matrix(nrow = 40, ncol = 3))
colnames(test) <- c('ID','pval','responder')

for (id in tgi$ID){
  i = i+1
  tmp1 <- tgi[tgi$ID == id ,]
  test$ID[i] <- id
  test$pval[i] <- (t.test(tmp1$VASburn, mu = 0, alternative = 'greater'))$p.value
  test$responder[i] <- isTRUE(test$pval[i] < .05)
}

# combine responder logic with main data-frame
test$responder <- ifelse(test$responder == TRUE, 1, 0)
test <- test[, c(1,3)]
df_res <- merge(df_res, test, by = 'ID')
  
# count the number of false responses
nNONRESP <- sum(test$responder == FALSE)
# print
print(paste0('Non responders: ', nNONRESP, '/', length(test$ID)))
```

# Let's look at the data!
```{r}
# Reorganise data-frame 
# pivot longer the VAS response by each quality of sensation
# do this for both RT and VAS
df_long <- df_res %>% 
  pivot_longer(cols = c(VASinit, VASburn, VASwarm, VAScold),
               names_to = 'quality',
               values_to = 'VAS')
df_long2 <- df_res %>% 
  pivot_longer(cols = c(RTinit, RTburn, RTwarm, RTcold),
               names_to = 'quality',
               values_to = 'RT')
# remove the VAS & RT from quality column
df_long$quality <- substr(df_long$quality, 4, 7)
df_long2$quality <- substr(df_long2$quality, 3, 6)
# remove columns from both then merge
df_long <- df_long[, c(1:12,17:19)]
df_long2 <- df_long2[, c(1:12,17:19)]
df_long <- merge(df_long, df_long2)

# then remove NaNs
df_long <- df_long %>% filter(!is.na(VAS))
# remove the initial trials - not important for now
init_burn <- filter(df_long, quality == 'init')
all_vas <- filter(df_long, quality != 'init')

# plot distribution of data
ggplot(df_long) +
  geom_density(aes(VAS, colour = manipulation)) +
  facet_wrap(~quality, scales = "free_y") +
  theme_bw()
```
# MAIN HYPOTHESES
# Plot descriptives for each hypotheses
Hypothesis 1: within vs. across dermatomes

```{r h1}
# calculate means
vas_meds <- aggregate(VAS ~ quality*manipulation*condition*cold_probe*ID, 
                      median, data = all_vas)
vas_h1 <- aggregate(VAS ~ quality*manipulation*condition*ID, mean, data = vas_meds)
# change name of manipulation
vas_h1$manipulation <- factor(vas_h1$manipulation,
                           labels = c('Non-TGI', 'TGI'))
# summary means for h1
h1_sum <- summarySEwithin(data = vas_h1, measurevar = 'VAS',
                               withinvars = c('manipulation', 'quality', 'condition'))

# plot the summary statistics
# first colours
blue <- brewer.pal(8, "Blues")
grey <- brewer.pal(8, "Greys")
purp <- brewer.pal(8, "Purples")
oran <- brewer.pal(8, "Oranges")
gren <- brewer.pal(8, "Greens")

# order conditions
h1_sum$condition <- factor(h1_sum$condition, levels = c('within', 'across'))
h1_sum$quality <- factor(h1_sum$quality, levels = c('cold', 'warm', 'burn'))

# plot
ggplot(h1_sum, aes(colour = quality, group = manipulation, alpha = manipulation)) + 
  geom_point(aes(condition, VAS), size = 2, position = position_dodge(-.3)) +
  geom_errorbar(aes(condition, ymin = VAS-ci, ymax = VAS+ci), width = .1, size = .7,
                position = position_dodge(-.3)) +
  geom_line(aes(condition, VAS), size = .7, position = position_dodge(-.3)) +
  facet_wrap(~quality) +
  scale_colour_manual(values = c(blue[5], oran[5], purp[5])) +
  scale_alpha_discrete(range = c(0.6, 1)) +
  ylim(0,50) +
  theme_bw() 
```

# Hypothesis 1: plot difference across conditions of interest
```{r h1diff}
# then pivot wider and calculate difference
vas_h1_diff <- vas_h1 %>% 
  pivot_wider(names_from = condition, values_from = VAS) %>% 
  mutate(difference = within - across)
# recode quality
vas_h1_diff$quality <- factor(vas_h1_diff$quality,
                           levels = c('cold', 'warm', 'burn'))

# summary statistics
h1_diff_sum <- summarySEwithin(data = vas_h1_diff, measurevar = 'difference',
                               withinvars = c('manipulation', 'quality'))

# now plot the difference
ggplot(data = vas_h1_diff, aes(colour = quality)) +
  geom_hline(yintercept = 0, colour = 'grey50') +
  geom_point(aes(manipulation, difference, group = ID), position = position_dodge(.2),
             alpha = .5) +
  geom_point(data = h1_diff_sum, aes(manipulation, difference), colour = 'grey15',
             fill = 'grey15',
             shape = 21, size = 3) +
  geom_errorbar(data = h1_diff_sum, aes(manipulation, ymin = difference-ci,
                                        ymax = difference+ci), 
                width = .1, size = .7, colour = 'grey15') +
  facet_wrap(~quality) +
  scale_colour_manual(values = c(blue[5], oran[5], purp[5])) +
  labs(title = 'Hypothesis 1: Segmental Distance',
       y = 'Within - Across VAS Ratings', x = NULL) +
  theme_classic() +
  theme(legend.position = 'none') -> h1_diff_plot

h1_diff_plot
ggsave('h1_difference.png', h1_diff_plot, path = anaPath, device = NULL, 
       width = 7, height = 4.5, dpi = 1000)
```

Hypothesis 2 a & b: relative location of warm and cold
```{r h2}
# Summary statistics
# First, change name of manipulation
vas_meds$manipulation <- factor(vas_meds$manipulation, labels = c('Non-TGI', 'TGI'))
h2_sum <- summarySEwithin(data = vas_meds, measurevar = 'VAS', 
                          withinvars = c('quality','manipulation','cold_probe'))

# organise data for plotting
vas_meds$cold_probe <- factor(vas_meds$cold_probe, levels = 
                                c('proximal', 'distal', 'rostral', 'caudal'))
h2_sum$cold_probe <- factor(h2_sum$cold_probe, levels = 
                                c('proximal', 'distal', 'rostral', 'caudal'))
# recoding cold probe location so can jitter
vas_meds$cold_code <- factor(vas_meds$cold_probe, labels = 
                                c(1,2,3,4))
h2_sum$cold_code <- factor(h2_sum$cold_probe, labels = 
                                c(1,2,3,4))
# creating jitter
vas_meds$xj <- jitter(as.numeric(vas_meds$cold_code), amount = .05)

nudge1 = -.1
nudge2 = .1

# plot all data - half-violins
# COLD
ggplot(data = vas_meds %>% 
         filter(quality == 'cold'),
       mapping = aes(x = xj, y = VAS, colour = manipulation, fill = manipulation)) +
  geom_point(shape = 21, alpha = .5, position = position_nudge(nudge2)) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'cold', cold_probe == 'proximal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'cold', cold_probe == 'distal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'cold', cold_probe == 'rostral'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'cold', cold_probe == 'caudal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  # summary stats
  geom_point(data = h2_sum %>% 
               filter(quality == 'cold'), 
             aes(x = as.numeric(cold_code), y = VAS),
             shape = 21, size = 2, colour = 'grey20', fill = 'grey30',
             position = position_nudge(nudge1)) +
  geom_errorbar(data = h2_sum %>% 
               filter(quality == 'cold'), 
               aes(x = as.numeric(cold_code), ymin = VAS-ci, ymax = VAS+ci),
               colour = 'grey20', width = .05, size = .7,
               position = position_nudge(nudge1)) +
  geom_line(data = h2_sum %>% 
              filter(quality == 'cold'), 
              aes(x = as.numeric(cold_code), y = VAS), 
              colour = 'grey20', size = .7, alpha = .6,
              position = position_nudge(nudge1)) +
  facet_wrap(~manipulation) +
  scale_colour_manual(values = c(blue[4], blue[6])) +
  scale_fill_manual(values = c(blue[4], blue[6])) +
  scale_x_continuous(breaks = c(1,2,3,4), labels = c('prox.','dist.','rost.','caud.')) +
  labs(title = 'Cold ratings', x = NULL, 
         y = 'VAS Rating (0-100)') +
  ylim(-0.5,100) +
  theme_classic() +
  theme(legend.position = 'none') -> h2_cold_plot

# WARM
ggplot(data = vas_meds %>% 
         filter(quality == 'warm'),
       mapping = aes(x = xj, y = VAS, colour = manipulation, fill = manipulation)) +
  geom_point(shape = 21, alpha = .5, position = position_nudge(nudge2)) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'warm', cold_probe == 'proximal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'warm', cold_probe == 'distal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'warm', cold_probe == 'rostral'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'warm', cold_probe == 'caudal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  # summary stats
  geom_point(data = h2_sum %>% 
               filter(quality == 'warm'), 
             aes(x = as.numeric(cold_code), y = VAS),
             shape = 21, size = 2, colour = 'grey20', fill = 'grey30',
             position = position_nudge(nudge1)) +
  geom_errorbar(data = h2_sum %>% 
               filter(quality == 'warm'), 
               aes(x = as.numeric(cold_code), ymin = VAS-ci, ymax = VAS+ci),
               colour = 'grey20', width = .05, size = .7,
               position = position_nudge(nudge1)) +
  geom_line(data = h2_sum %>% 
              filter(quality == 'warm'), 
              aes(x = as.numeric(cold_code), y = VAS), 
              colour = 'grey20', size = .7, alpha = .6,
              position = position_nudge(nudge1)) +
  facet_wrap(~manipulation) +
  scale_colour_manual(values = c(oran[4], oran[6])) +
  scale_fill_manual(values = c(oran[4], oran[6])) +
  scale_x_continuous(breaks = c(1,2,3,4), labels = c('prox.','dist.','rost.','caud.')) +
  labs(title = 'Warm ratings', x = 'Location of cold probe', 
         y = NULL) +
  ylim(-0.5,100) +
  theme_classic() +
  theme(legend.position = 'none') -> h2_warm_plot

# BURN
ggplot(data = vas_meds %>% 
         filter(quality == 'burn'),
       mapping = aes(x = xj, y = VAS, colour = manipulation, fill = manipulation)) +
  geom_point(shape = 21, alpha = .5, position = position_nudge(nudge2)) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'burn', cold_probe == 'proximal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'burn', cold_probe == 'distal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'burn', cold_probe == 'rostral'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  geom_half_violin(
    data = vas_meds %>% 
    filter(quality == 'burn', cold_probe == 'caudal'),
    aes(x = xj, y = VAS), 
    position = position_nudge(x = nudge1), side = "l", alpha = .4) +
  # summary stats
  geom_point(data = h2_sum %>% 
               filter(quality == 'burn'), 
             aes(x = as.numeric(cold_code), y = VAS),
             shape = 21, size = 2, colour = 'grey20', fill = 'grey30',
             position = position_nudge(nudge1)) +
  geom_errorbar(data = h2_sum %>% 
               filter(quality == 'burn'), 
               aes(x = as.numeric(cold_code), ymin = VAS-ci, ymax = VAS+ci),
               colour = 'grey20', width = .05, size = .7,
               position = position_nudge(nudge1)) +
  geom_line(data = h2_sum %>% 
              filter(quality == 'burn'), 
              aes(x = as.numeric(cold_code), y = VAS), 
              colour = 'grey20', size = .7, alpha = .6,
              position = position_nudge(nudge1)) +
  facet_wrap(~manipulation) +
  scale_colour_manual(values = c(purp[4], purp[6])) +
  scale_fill_manual(values = c(purp[4], purp[6])) +
  scale_x_continuous(breaks = c(1,2,3,4), labels = c('prox.','dist.','rost.','caud.')) +
  labs(title = 'Burn ratings', x = 'Location of cold probe', 
         y = 'VAS Rating (0-100)') +
  ylim(-0.5,100) +
  theme_classic() +
  theme(legend.position = 'none') -> h2_burn_plot
  
# arrange entire plot
h2_plot <- ggarrange(h2_cold_plot, h2_warm_plot, h2_burn_plot,
                     nrow = 2, ncol = 2)
h2_plot

ggsave('h2_alldat_plot.png', h2_plot, device = NULL, path = anaPath,
       width = 10, height = 6.5, dpi = 600)
```

# ZOIB regression
Running main analysis of a zero inflated beta regression
Outcome: VAS
Predictors: manipulation (CNT, TGI), cold probe location ()
Run a seperate regression for each quality
# Cold
# Warm
# Burn

# Run one regression including quality as a predictor

