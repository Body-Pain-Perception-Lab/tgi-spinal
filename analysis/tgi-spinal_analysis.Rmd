---
title: "TGI Spinal Analysis Code"
author: "A.G. Mitchell"
date: "2022-12-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Loading libraries
library(RColorBrewer)
library(ggpubr)
library(Rmisc)
library(tidyverse)
library(gghalves)
library(ggpol)
```

# Loading data
```{r paths, echo = FALSE}
# paths
datPath <- '/Users/au706616/Documents/Experiments/SPINALTGI/Raw/'
anaPath <- '/Users/au706616/Documents/Experiments/SPINALTGI/Analysis/'

# Extract all .csv files and compile
filenames <- dir(datPath, recursive = TRUE, full.names = FALSE, pattern = '.csv')
# empty dataframes for data
## with new data trials file will have changed to include temperature coding!
df_trials <- read.csv(text='procedure,trial_type,arm,condition,dermatome,order,cold_probe,trial_n,coolTemp,warmTempID,manipulation')
df_VAS <- read.csv(text='VASinit,VASburn,VASwarm,VAScold,trial_n,ID,manipulation')
df_RT <- read.csv(text='RTinit,RTburn,RTwarm,RTcold,trial_n,ID,manipulation')

## Data compiling
# trial files
setwd(datPath)
for (file in filenames){
  # trial files
  if (isTRUE(substr(basename(file), 24, 24)=="t")){
    tmp <- read.csv(file)
    tmp$ID <- substr(basename(file), 4, 6)
    tmp$manipulation <- substr(basename(file), 17, 19)
    df_trials <- rbind(df_trials, tmp)
  }
  # VAS response files
  if (isTRUE(substr(basename(file), 24, 29)=="rating")){
    tmp <- read.csv(file, header = FALSE)
    colnames(tmp) <- c('VASinit','VASburn','VASwarm','VAScold','trial_n')
    tmp$ID <- substr(basename(file), 4, 6)
    tmp$manipulation <- substr(basename(file), 17, 19)
    df_VAS <- rbind(df_VAS, tmp)
  }
  # VAS RT files
  if (isTRUE(substr(basename(file), 24, 29)=="respti")){
    tmp <- read.csv(file, header = FALSE)
    colnames(tmp) <- c('RTinit','RTburn','RTwarm','RTcold','trial_n')
    tmp$ID <- substr(basename(file), 4, 6)
    tmp$manipulation <- substr(basename(file), 17, 19)
    df_RT <- rbind(df_RT, tmp)
  }
}

# merge all files
df_res <- merge(df_trials, df_VAS, by = c('ID','trial_n','manipulation'))
df_res <- merge(df_res, df_RT, by = c('ID','trial_n','manipulation'))

# remove participant 019, stopped testing halfway
df_res <- df_res[df_res$ID != '019' ,]
```

# Data organisation
```{r}
# transform the ID of participants to remove 0
df_res$ID <- as.numeric(df_res$ID)
# recode conditions
df_res <- df_res %>%
  mutate(condition = recode(condition, '1' = 'within', '2' = 'across'),
         cold_probe = recode(cold_probe, 'C6' = 'rostral', 'T1' = 'caudal',
                             'dist' = 'distal', 'prox' = 'proximal'))
# change levels 
df_res$cold_probe <- factor(df_res$cold_probe, 
                            levels = c("caudal", "rostral", "distal", "proximal"))

# incorporate demographics
# the warm and cold TGI and CNT temperatures did not code properly on the trial .csv
# have saved these in the demo .csv as well, so will add these in
demoFile <- 'STGI_participant-demographics.csv'
fileName = paste(datPath, demoFile, sep = '')
df_demo <- read.csv(fileName)
# merge
test <- merge(df_res, df_demo)

# save new data-frame
fileName = paste(anaPath, 'STGI_compiled-data.csv', sep = '')
write.csv(df_res, fileName, row.names = FALSE)

# check we have 40 participants with 96 trials
id_check <- count(df_res, 'ID')
id_check
```

# Responder check
Check whether participants median burning ratings for TGI is significantly above 0
If not, flag them as a 'non-responder'
```{r}
# Calculate median burning rating for all participants
# TGI trials only
# Then flag how many are not sig > 0
df_med <- aggregate(VASburn~ID*manipulation*cold_probe*trial_type, median, data = df_res)
tgi <-  df_med %>% 
  filter(manipulation == 'TGI')
cnt <-  df_med %>% 
  filter(manipulation == 'CNT')

# identify test results where pvalue is < .05
tgi$ID <- as.factor(tgi$ID)
i = 0
test = data.frame(matrix(nrow = 40, ncol = 3))
colnames(test) <- c('ID','pval','responder')
for (id in tgi$ID){
  i = i+1
  tmp1 <- tgi[tgi$ID == id ,]
  test$ID[i] <- id
  test$pval[i] <- (t.test(tmp1$VASburn, mu = 0, alternative = 'greater'))$p.value
  test$responder[i] <- isTRUE(test$pval[i] < .05)
}

# combine responder logic with main data-frame
test$responder <- ifelse(test$responder == TRUE, 1, 0)
test <- test[, c(1,3)]
df_res <- merge(df_res, test, by = 'ID')
  
# count the number of false responses
nNONRESP <- sum(test$responder == FALSE)
# print
print(paste0('Non responders: ', nNONRESP, '/', length(test$ID)))
```

# Let's look at the data!
```{r}
# Reorganise data-frame 
# pivot longer the VAS response by each quality of sensation
# do this for both RT and VAS
df_long <- df_res %>% 
  pivot_longer(cols = c(VASinit, VASburn, VASwarm, VAScold),
               names_to = 'quality',
               values_to = 'VAS')
df_long2 <- df_res %>% 
  pivot_longer(cols = c(RTinit, RTburn, RTwarm, RTcold),
               names_to = 'quality',
               values_to = 'RT')
# remove the VAS & RT from quality column
df_long$quality <- substr(df_long$quality, 4, 7)
df_long2$quality <- substr(df_long2$quality, 3, 6)
# remove columns from both then merge
df_long <- df_long[, c(1:12,17:19)]
df_long2 <- df_long2[, c(1:12,17:19)]
df_long <- merge(df_long, df_long2)

# then remove NaNs
df_long <- df_long %>% filter(!is.na(VAS))
# remove the initial trials - not important for now
init_burn <- filter(df_long, quality == 'init')
all_vas <- filter(df_long, quality != 'init')

# plot distribution of data
ggplot(df_long) +
  geom_density(aes(VAS, colour = manipulation)) +
  facet_wrap(~quality, scales = "free_y") +
  theme_bw()
```
# MAIN HYPOTHESES
# Plot descriptives for each hypotheses
Hypothesis 1: within vs. across dermatomes

```{r}
# calculate means
vas_meds <- aggregate(VAS ~ quality*manipulation*condition*cold_probe*ID, 
                      median, data = all_vas)
vas_h1 <- aggregate(VAS ~ quality*manipulation*condition*ID, mean, data = vas_meds)

# summary means for h1


# then plot :D
# first colours
blue <- brewer.pal(6, "Blues")
grey <- brewer.pal(6, "Greys")
purp <- brewer.pal(6, "Purples")
oran <- brewer.pal(6, "Oranges")
gren <- brewer.pal(6, "Greens")

# nudge and jitter
nudge1 = -0.1
nudge2 = 0.1
vas_h1$dermatome <- ifelse(vas_h1$condition == 'within', 1, 2)  # recode within and across
vas_h1$condition <- factor(vas_h1$condition, labels = c('within', 'across'),
                           levels = c('within', 'across'))
# recode quality for this plot
vas_h1$quality1[vas_h1$quality == 'cold'] <- 1
vas_h1$quality1[vas_h1$quality == 'warm'] <- 2
vas_h1$quality1[vas_h1$quality == 'burn'] <- 3

vas_h1$xj <- jitter(vas_h1$quality1, 0.2)

ggplot(data = vas_h1, aes(colour = condition, group = ID)) +
  geom_point(data = vas_h1 %>% 
               filter(manipulation == 'CNT', condition == 'within'),
               aes(xj, VAS), position = position_nudge(-.1)) +
  geom_point(data = vas_h1 %>% 
               filter(manipulation == 'CNT', condition == 'across'),
               aes(xj, VAS), position = position_nudge(.1)) +
  scale_colour_manual(values = c(purp[6], purp[3])) +
  scale_x_continuous(breaks=c(1,2,3), labels=c("cold", "warm", "burn")) +
  theme_classic() -> h1_cnt_plot

ggplot(data = vas_h1, aes(colour = condition)) +
  geom_point(data = vas_h1 %>% 
               filter(manipulation == 'TGI', condition == 'within'),
               aes(xj, VAS), position = position_nudge(-.1)) +
  geom_point(data = vas_h1 %>% 
               filter(manipulation == 'TGI', condition == 'across'),
               aes(xj, VAS), position = position_nudge(.1)) +
  scale_colour_manual(values = c(purp[6], purp[3])) +
  scale_x_continuous(breaks=c(1,2,3), labels=c("cold", "warm", "burn")) +
  theme_classic() -> h1_tgi_plot

h1_plot <- ggarrange(h1_cnt_plot, h1_tgi_plot,
                     ncol = 2, nrow = 1,
                     common.legend = TRUE)
h1_plot
```

Hypothesis 2 a & b: relative location of warm and cold

# ZOIB regression
Running main analysis of a zero inflated beta regression
Outcome: VAS
Predictors: manipulation (CNT, TGI), cold probe location ()
Run a seperate regression for each quality
# Cold
# Warm
# Burn

# Run one regression including quality as a predictor

